# https://circleci.com/docs/configuration#machine
machine:
  php:
    # https://circleci.com/docs/environment#php
    version: 5.5.11
  environment:
    # DB config. Using default CircleCI's database.
    PANTHEON_BRANCH: ci$CIRCLE_BUILD_NUM
    PANTHEON_SITE: migrate-pantheon-d8

dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
test:
  pre:
    #- cd testing/ && composer install
    - composer global require pantheon-systems/terminus
    - terminus auth login --machine-token=$TerminusToken

  override:
    # @todo, pull in upstream updates, wipe and install drupal.
    - terminus site create-env --to-env=$PANTHEON_BRANCH --from-env=dev --site=$PANTHEON_SITE
    - git clone $(terminus site connection-info --field=git_url --site=$PANTHEON_SITE  --env=$PANTHEON_BRANCH) ~/drupal8 --branch=$PANTHEON_BRANCH
    - cd ~/migrate_pantheon/tests/circle && ./setup-d8-code
    - cd ~/migrate_pantheon/tests/circle && ./execute-circle-behat
